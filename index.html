<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TitanOS Ultra Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800;900&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root[data-theme="light"] {
            --bg-color: #f5f5f7;
            --glass-bg: rgba(255, 255, 255, 0.4);
            --glass-border: rgba(255, 255, 255, 0.6);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
            --text-main: #1d1d1f;
            --text-muted: #86868b;
            --accent: #000000;
            --accent-light: #333333;
            --success: #34c759;
            --danger: #ff3b30;
            --blob-1: #007aff;
            --blob-2: #34c759;
            --blob-opacity: 0.15;
            --table-hover: rgba(255, 255, 255, 0.6);
            --input-bg: rgba(255, 255, 255, 0.5);
        }

        :root[data-theme="dark"] {
            --bg-color: #000000;
            --glass-bg: rgba(20, 20, 25, 0.4);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --text-main: #f5f5f7;
            --text-muted: #a1a1a6;
            --accent: #ffffff;
            --accent-light: #cccccc;
            --success: #30d158;
            --danger: #ff453a;
            --blob-1: #0a84ff;
            --blob-2: #30d158;
            --blob-opacity: 0.2;
            --table-hover: rgba(255, 255, 255, 0.05);
            --input-bg: rgba(0, 0, 0, 0.5);
        }

        :root { --sidebar-width: 280px; }

        * {
            box-sizing: border-box; margin: 0; padding: 0;
            font-family: 'Cairo', sans-serif;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.4s ease, color 0.4s ease, border-color 0.4s ease;
        }

        body { background-color: var(--bg-color); color: var(--text-main); overflow-x: hidden; min-height: 100vh; }

        .liquid-bg { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -2; background: var(--bg-color); overflow: hidden; }
        .blob { position: absolute; border-radius: 50%; filter: blur(100px); opacity: var(--blob-opacity); animation: float 20s infinite alternate cubic-bezier(0.4, 0, 0.2, 1); transform: translateZ(0); }
        .blob-1 { width: 50vw; height: 50vw; background: var(--blob-1); top: -10%; right: -10%; }
        .blob-2 { width: 60vw; height: 60vw; background: var(--blob-2); bottom: -20%; left: -10%; animation-delay: -5s; }

        .glass-panel { background: var(--glass-bg); backdrop-filter: blur(25px) saturate(200%); -webkit-backdrop-filter: blur(25px) saturate(200%); border: 1px solid var(--glass-border); border-radius: 20px; box-shadow: var(--glass-shadow); }

        #lock-screen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: var(--glass-bg); backdrop-filter: blur(50px) saturate(200%); -webkit-backdrop-filter: blur(50px) saturate(200%); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: transform 0.7s cubic-bezier(0.7, 0, 0.3, 1), opacity 0.6s ease; }
        #lock-screen.unlocked { transform: scale(1.3); opacity: 0; pointer-events: none; }
        .user-avatar { width: 100px; height: 100px; border-radius: 50%; background: var(--text-main); color: var(--bg-color); display: flex; align-items: center; justify-content: center; font-size: 2.5rem; margin-bottom: 1.5rem; box-shadow: var(--glass-shadow); }
        .welcome-text { font-size: 1.8rem; font-weight: 800; margin-bottom: 2rem; }
        .login-box { display: flex; flex-direction: column; gap: 1rem; width: 100%; max-width: 300px; }
        .apple-input { width: 100%; padding: 1rem 1.5rem; border-radius: 14px; border: 1px solid var(--glass-border); background: var(--input-bg); color: var(--text-main); font-size: 1.1rem; text-align: center; outline: none; }
        .apple-input:focus { border-color: var(--text-main); box-shadow: 0 0 0 3px rgba(134, 134, 139, 0.2); }
        .apple-btn { width: 100%; padding: 1rem; border-radius: 14px; background: var(--text-main); color: var(--bg-color); border: none; font-size: 1.1rem; font-weight: 800; cursor: pointer; transition: transform 0.2s; }
        .apple-btn:active { transform: scale(0.97); }
        #auth-error { color: var(--danger); font-size: 0.95rem; font-weight: 800; margin-top: 0.5rem; text-align: center; display: none; }

        #app-core { display: flex; width: 100%; min-height: 100vh; position: relative; z-index: 1; }

        .sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; right: 0; top: 0; padding: 2rem 1.5rem; display: flex; flex-direction: column; gap: 1.5rem; z-index: 100; transition: transform 0.4s ease; border-radius: 0; border-left: 1px solid var(--glass-border); border-right: none; }
        .sidebar-brand { font-size: 2rem; font-weight: 900; color: var(--text-main); display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; }
        .theme-btn { background: none; border: none; font-size: 1.5rem; color: var(--text-main); cursor: pointer; transition: transform 0.3s; }
        .theme-btn:hover { transform: scale(1.1); }
        .nav-menu { list-style: none; display: flex; flex-direction: column; gap: 0.5rem; }
        .nav-item { padding: 1rem 1.2rem; border-radius: 14px; cursor: pointer; font-weight: 800; display: flex; align-items: center; gap: 1rem; color: var(--text-muted); background: transparent; }
        .nav-item.active, .nav-item:hover { background: var(--text-main); color: var(--bg-color); }

        .main-content { margin-right: var(--sidebar-width); width: calc(100% - var(--sidebar-width)); padding: 2.5rem; min-height: 100vh; }
        .top-nav { display: none; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .menu-btn { font-size: 1.5rem; background: none; border: none; cursor: pointer; color: var(--text-main); }
        .view-section { display: none; animation: fadeUp 0.4s ease forwards; }
        .view-section.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .search-area { padding: 2rem; margin-bottom: 2rem; }
        .input-group { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
        .search-input { flex: 1; padding: 1.2rem 1.5rem; font-size: 1.1rem; font-weight: 600; border-radius: 14px; border: 1px solid var(--glass-border); background: var(--input-bg); color: var(--text-main); outline: none; }
        .search-input:focus { border-color: var(--text-main); }
        .btn-extract { background: var(--text-main); color: var(--bg-color); border: none; padding: 0 2.5rem; border-radius: 14px; font-size: 1.1rem; font-weight: 800; cursor: pointer; }
        .btn-extract:hover { opacity: 0.9; }
        .btn-extract:disabled { opacity: 0.5; cursor: not-allowed; }

        .options-row { display: flex; gap: 1.5rem; flex-wrap: wrap; }
        .toggle-switch { display: flex; align-items: center; gap: 0.5rem; font-weight: 800; cursor: pointer; user-select: none; }
        .toggle-switch input { width: 20px; height: 20px; accent-color: var(--text-main); }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { padding: 1.8rem; text-align: center; }
        .stat-card i { font-size: 2rem; color: var(--text-main); margin-bottom: 1rem; }
        .stat-card h4 { font-size: 1rem; color: var(--text-muted); margin-bottom: 0.5rem; font-weight: 800;}
        .stat-card p { font-size: 2rem; font-weight: 900; font-family: 'Inter', sans-serif; color: var(--text-main); }

        .table-wrap { overflow-x: auto; border-radius: 14px; margin-top: 1rem; }
        table { width: 100%; border-collapse: collapse; text-align: right; }
        th, td { padding: 1.2rem; border-bottom: 1px solid var(--glass-border); font-size: 0.95rem; font-weight: 600; }
        th { color: var(--text-muted); font-weight: 800; }
        tr:hover td { background: var(--table-hover); }

        .badge-res { background: var(--glass-border); color: var(--text-main); padding: 4px 10px; border-radius: 6px; font-family: 'Inter'; font-size: 0.85rem; font-weight: 800; }
        .btn-action { background: var(--text-main); color: var(--bg-color); padding: 8px 18px; border-radius: 8px; text-decoration: none; font-weight: 800; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 6px; border:none; cursor:pointer;}
        .btn-danger { background: var(--danger); color: white; }

        .player-container { background: #000; border-radius: 20px; overflow: hidden; aspect-ratio: 16/9; width: 100%; margin-bottom: 1.5rem; position: relative; }
        video, audio { width: 100%; height: 100%; outline: none; }
        .loader-ring { display: none; width: 35px; height: 35px; border: 4px solid rgba(134,134,139,0.2); border-top-color: var(--text-main); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 2rem auto; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            .sidebar { transform: translateX(100%); }
            .sidebar.open { transform: translateX(0); box-shadow: -20px 0 40px rgba(0,0,0,0.5); }
            .main-content { margin-right: 0; width: 100%; padding: 1.5rem; }
            .top-nav { display: flex; }
            .input-group { flex-direction: column; }
            .btn-extract { padding: 1.2rem; justify-content: center; }
        }
    </style>
</head>
<body>

    <div class="liquid-bg"><div class="blob blob-1"></div><div class="blob blob-2"></div></div>

    <div id="lock-screen">
        <div class="user-avatar"><i class="fa-solid fa-microchip"></i></div>
        <div class="welcome-text">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ</div>
        <div class="login-box">
            <input type="text" id="auth-user" class="apple-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" autocomplete="off">
            <input type="password" id="auth-pass" class="apple-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button class="apple-btn" onclick="unlockSystem()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            <div id="auth-error">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©</div>
        </div>
    </div>

    <div id="app-core">
        <aside class="sidebar glass-panel" id="sidebar">
            <div class="sidebar-brand">
                <span>EG Ultra</span>
                <button class="theme-btn" onclick="toggleTheme()"><i class="fa-solid fa-moon" id="theme-icon"></i></button>
            </div>
            <ul class="nav-menu">
                <li class="nav-item active" onclick="switchView('home', this)"><i class="fa-solid fa-bolt"></i> Ø§Ù„Ù…Ø­Ø±Ùƒ</li>
                <li class="nav-item" onclick="switchView('stats', this)"><i class="fa-solid fa-chart-simple"></i> Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©</li>
                <li class="nav-item" onclick="switchView('history', this)"><i class="fa-solid fa-clock-rotate-left"></i> Ø§Ù„Ø³Ø¬Ù„</li>
                <li class="nav-item" onclick="switchView('settings', this)"><i class="fa-solid fa-sliders"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</li>
                <li class="nav-item" style="color: var(--danger); margin-top: auto;" onclick="lockSystem()"><i class="fa-solid fa-lock"></i> Ù‚ÙÙ„</li>
            </ul>
        </aside>

        <main class="main-content">
            <nav class="top-nav">
                <h2 style="font-weight: 900;">EG</h2>
                <div>
                    <button class="theme-btn" style="margin-left: 1rem;" onclick="toggleTheme()"><i class="fa-solid fa-moon" id="theme-icon-mobile"></i></button>
                    <button class="menu-btn" onclick="document.getElementById('sidebar').classList.toggle('open')"><i class="fa-solid fa-bars"></i></button>
                </div>
            </nav>

            <section id="view-home" class="view-section active">
                <div class="search-area glass-panel">
                    <h2 style="margin-bottom: 1.5rem; font-weight: 900;">Ultra Engine</h2>
                    <div class="input-group">
                        <input type="text" id="media-url" class="search-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ø¨Ø­Ø« Ù‡Ù†Ø§...">
                        <button id="btn-submit" class="btn-extract" onclick="requestExtraction()">Ø§Ø³ØªØ®Ø±Ø§Ø¬</button>
                    </div>
                    <div class="options-row">
                        <label class="toggle-switch"><input type="checkbox" id="opt-audio" checked> ÙˆØ¶Ø¹ Ø§Ù„ØµÙˆØª (Ø£Ø³Ø±Ø¹)</label>
                        <label class="toggle-switch"><input type="checkbox" id="opt-refresh"> ØªØ­Ø¯ÙŠØ« Ø¥Ø¬Ø¨Ø§Ø±ÙŠ (Ø¨Ø¯ÙˆÙ† ÙƒØ§Ø´)</label>
                    </div>
                    <div id="main-loader" class="loader-ring"></div>
                </div>

                <div id="result-display" style="display: none;">
                    <div class="player-container" id="player-box"></div>
                    
                    <div class="glass-panel" style="padding: 1.5rem; margin-bottom: 2rem;">
                        <h3 id="res-title" style="margin-bottom: 1rem; font-weight: 900;">...</h3>
                        <div style="display: flex; gap: 1rem; font-family: Inter; font-weight: 800; color: var(--text-muted); font-size: 0.9rem;">
                            <span id="res-time"></span> | <span id="res-method"></span> | <span id="res-live"></span>
                        </div>
                    </div>

                    <div class="glass-panel" style="padding: 1.5rem;">
                        <h3 style="font-weight: 900; margin-bottom: 1rem;">Ø§Ù„Ø¬ÙˆØ¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</h3>
                        <div class="table-wrap">
                            <table id="formats-table">
                                <thead><tr><th>Ø§Ù„ØµÙŠØºØ©</th><th>Ø§Ù„Ø¬ÙˆØ¯Ø©</th><th>ÙƒÙˆØ¯Ùƒ</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section id="view-stats" class="view-section">
                <h2 style="margin-bottom: 1.5rem; font-weight: 900;">Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±</h2>
                <div class="stats-grid">
                    <div class="stat-card glass-panel">
                        <i class="fa-solid fa-network-wired"></i>
                        <h4>WebSockets</h4>
                        <p id="stat-ws">0</p>
                    </div>
                    <div class="stat-card glass-panel">
                        <i class="fa-solid fa-microchip"></i>
                        <h4>RAM Usage</h4>
                        <p id="stat-ram">-- MB</p>
                    </div>
                    <div class="stat-card glass-panel">
                        <i class="fa-solid fa-server"></i>
                        <h4>Total Requests</h4>
                        <p id="stat-reqs">0</p>
                    </div>
                    <div class="stat-card glass-panel">
                        <i class="fa-solid fa-database"></i>
                        <h4>Cache Items</h4>
                        <p id="stat-cache">0</p>
                    </div>
                </div>
                <button class="btn-action" onclick="fetchAdminStats()"><i class="fa-solid fa-rotate"></i> ØªØ­Ø¯ÙŠØ«</button>
            </section>

            <section id="view-history" class="view-section">
                <h2 style="margin-bottom: 1.5rem; font-weight: 900;">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h2>
                <div class="glass-panel" style="padding: 1.5rem;">
                    <div class="table-wrap">
                        <table id="history-table">
                            <thead><tr><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <button class="btn-action btn-danger" style="margin-top: 1.5rem;" onclick="clearHistory()"><i class="fa-solid fa-trash"></i> Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
                </div>
            </section>

            <section id="view-settings" class="view-section">
                <h2 style="margin-bottom: 1.5rem; font-weight: 900;">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³ÙŠØ±ÙØ±</h2>
                <div class="glass-panel" style="padding: 2rem; display: flex; flex-direction: column; gap: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--glass-border); padding-bottom: 1.5rem;">
                        <div>
                            <h3 style="font-weight: 800;">Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©</h3>
                            <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 5px;">Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø±Ø§Ù… Ø§Ù„Ø³ÙŠØ±ÙØ±.</p>
                        </div>
                        <button class="btn-action btn-danger" onclick="clearServerCache()">ØªÙ†ÙÙŠØ°</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const newTheme = current === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('eg_theme', newTheme);
            updateThemeIcons(newTheme);
        }

        function updateThemeIcons(theme) {
            const iconClass = theme === 'light' ? 'fa-moon' : 'fa-sun';
            document.getElementById('theme-icon').className = `fa-solid ${iconClass}`;
            document.getElementById('theme-icon-mobile').className = `fa-solid ${iconClass}`;
        }

        const savedTheme = localStorage.getItem('eg_theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        updateThemeIcons(savedTheme);

        // Ù‡Ù†Ø§ Ø­Ø·ÙŠÙ†Ø§ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„ØµØ­ÙŠØ­ Ø§Ù„Ù„ÙŠ Ù…ØªØ³Ø¬Ù„ ÙÙŠ Ø³ÙŠØ±ÙØ± Go
        const API_KEY = "Titan_2026_Ultra_Fast"; 
        const BASE_URL = window.location.origin;
        let wsConnection = null;

        if (sessionStorage.getItem("eg_unlocked") === "true") {
            document.getElementById("lock-screen").style.display = "none";
            initSystem();
        }

        function unlockSystem() {
            const u = document.getElementById("auth-user").value;
            const p = document.getElementById("auth-pass").value;
            const err = document.getElementById("auth-error");

            if (u === "admin" && p === "asdfghjkl05896") {
                err.style.display = "none";
                const lock = document.getElementById("lock-screen");
                lock.classList.add("unlocked");
                setTimeout(() => {
                    lock.style.display = "none";
                    sessionStorage.setItem("eg_unlocked", "true");
                    initSystem();
                }, 700); 
            } else {
                err.style.display = "block";
            }
        }

        function lockSystem() {
            sessionStorage.removeItem("eg_unlocked");
            location.reload();
        }

        function switchView(viewId, el) {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('view-' + viewId).classList.add('active');
            el.classList.add('active');
            if(window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('open');
            
            if(viewId === 'stats') fetchAdminStats();
            if(viewId === 'history') loadHistory();
        }

        function initSystem() {
            connectWebSocket();
            fetchAdminStats();
            setInterval(fetchAdminStats, 15000); 
        }

        function connectWebSocket() {
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            wsConnection = new WebSocket(`${wsProtocol}//${location.host}/api/v1/ws/stream`);

            wsConnection.onopen = () => {
                wsConnection.send(JSON.stringify({ auth: API_KEY }));
            };

            wsConnection.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleExtractionResult(data);
            };

            wsConnection.onclose = () => {
                setTimeout(connectWebSocket, 5000);
            };
        }

        async function requestExtraction() {
            const url = document.getElementById("media-url").value.trim();
            if (!url) return;

            document.getElementById("main-loader").style.display = "block";
            document.getElementById("result-display").style.display = "none";
            document.getElementById("btn-submit").disabled = true;

            const isAudio = document.getElementById("opt-audio").checked;
            const refresh = document.getElementById("opt-refresh").checked;

            if (wsConnection && wsConnection.readyState === WebSocket.OPEN && !refresh) {
                wsConnection.send(JSON.stringify({ url: url, audio_only: isAudio }));
            } else {
                try {
                    const res = await fetch(`${BASE_URL}/api/v1/extract?url=${encodeURIComponent(url)}&audio_only=${isAudio}&force_refresh=${refresh}`, {
                        headers: { 'X-Titan-Key': API_KEY, 'Accept': 'application/json' }
                    });
                    const data = await res.json();
                    handleExtractionResult(data);
                } catch (e) {
                    alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±.");
                    resetExtractionUI();
                }
            }
        }

        document.getElementById('media-url').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') requestExtraction();
        });

        function handleExtractionResult(data) {
            resetExtractionUI();
            if (!data.success) {
                alert("ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬: " + data.message);
                return;
            }

            document.getElementById("result-display").style.display = "block";
            document.getElementById("res-title").innerText = data.title || "Unknown Title";
            document.getElementById("res-time").innerText = `${data.process_time_ms.toFixed(2)} ms`;
            document.getElementById("res-method").innerText = data.cached ? "âš¡ Ù…Ø£Ø®ÙˆØ° Ù…Ù† Ø§Ù„ÙƒØ§Ø´" : "ğŸŒ Go Native Engine";
            document.getElementById("res-live").innerText = data.is_live ? "Ø¨Ø« Ù…Ø¨Ø§Ø´Ø±" : "ÙÙŠØ¯ÙŠÙˆ Ù…Ø³Ø¬Ù„";

            const pBox = document.getElementById("player-box");
            pBox.innerHTML = "";
            let mediaType = "video";
            
            const isAudioOnlyChecked = document.getElementById("opt-audio").checked;
            if (isAudioOnlyChecked && !data.is_live && !data.direct_stream_url.includes('mp4')) {
                mediaType = "audio";
            }
            
            const player = document.createElement(mediaType);
            player.controls = true;
            player.src = data.direct_stream_url;
            
            if (mediaType === "audio" && data.thumbnails && data.thumbnails.length > 0) {
                const thumbUrl = data.thumbnails[data.thumbnails.length - 1].url;
                pBox.style.backgroundImage = `url('${thumbUrl}')`;
                pBox.style.backgroundSize = 'contain';
                pBox.style.backgroundPosition = 'center';
                pBox.style.backgroundRepeat = 'no-repeat';
                player.style.backgroundColor = 'rgba(0,0,0,0.7)';
            } else {
                pBox.style.backgroundImage = 'none';
            }
            
            pBox.appendChild(player);

            const tbody = document.querySelector("#formats-table tbody");
            tbody.innerHTML = "";
            
            let allFormats = [];
            if(data.smart_formats) {
                allFormats = [...(data.smart_formats.best_muxed || []), ...(data.smart_formats.audio_only || []), ...(data.smart_formats.video_only || [])];
            }

            if (allFormats.length === 0 && data.direct_stream_url) {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td><span class="badge-res">direct</span></td>
                    <td dir="ltr" style="font-weight:800; color:var(--text-main);">Auto</td>
                    <td>native</td>
                    <td>
                        <a href="${data.direct_stream_url}" target="_blank" class="btn-action"><i class="fa-solid fa-download"></i></a>
                    </td>
                `;
                tbody.appendChild(tr);
            } else {
                allFormats.slice(0, 15).forEach(f => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td><span class="badge-res">${f.ext || 'N/A'}</span></td>
                        <td dir="ltr" style="font-weight:800; color:var(--text-main);">${f.resolution || 'N/A'}</td>
                        <td>${f.vcodec !== 'none' ? f.vcodec : f.acodec}</td>
                        <td>
                            <a href="${f.url}" target="_blank" class="btn-action"><i class="fa-solid fa-download"></i></a>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            saveToHistory(data.title, mediaType, data.direct_stream_url);
        }

        function resetExtractionUI() {
            document.getElementById("main-loader").style.display = "none";
            document.getElementById("btn-submit").disabled = false;
        }

        function saveToHistory(title, type, url) {
            let hist = JSON.parse(localStorage.getItem("eg_history") || "[]");
            hist.unshift({ title, type, url, time: new Date().toLocaleString('ar-EG') });
            if(hist.length > 50) hist.pop();
            localStorage.setItem("eg_history", JSON.stringify(hist));
        }

        function loadHistory() {
            let hist = JSON.parse(localStorage.getItem("eg_history") || "[]");
            const tbody = document.querySelector("#history-table tbody");
            tbody.innerHTML = "";
            hist.forEach(h => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td style="max-width:200px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${h.title}</td>
                    <td><span class="badge-res">${h.type}</span></td>
                    <td dir="ltr">${h.time}</td>
                    <td><a href="${h.url}" target="_blank" class="btn-action" style="padding:6px 12px;"><i class="fa-solid fa-play"></i></a></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function clearHistory() {
            localStorage.removeItem("eg_history");
            loadHistory();
        }

        async function fetchAdminStats() {
            try {
                const res = await fetch(`${BASE_URL}/api/v1/admin/stats`, { headers: { 'X-Titan-Key': API_KEY } });
                if (!res.ok) return;
                const stats = await res.json();
                document.getElementById("stat-ws").innerText = stats.active_ws_connections || 0;
                document.getElementById("stat-ram").innerText = stats.memory_usage || "-- MB";
                document.getElementById("stat-reqs").innerText = stats.total_requests || 0;
                document.getElementById("stat-cache").innerText = stats.cached_files_count || 0;
            } catch (e) {}
        }

        async function clearServerCache() {
            if(!confirm("Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø±Ø§Ù…ØŸ")) return;
            try {
                const res = await fetch(`${BASE_URL}/api/v1/admin/clear_cache`, { method: "POST", headers: { 'X-Titan-Key': API_KEY } });
                const data = await res.json();
                if(data.success) {
                    alert("ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ø§Ù….");
                    fetchAdminStats();
                }
            } catch(e) {}
        }
    </script>
</body>
</html>
