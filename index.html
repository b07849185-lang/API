<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EG Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800;900&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ==========================================================================
           1. Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª (120FPS GPU Optimized)
           ========================================================================== */
        :root {
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.9);
            --glass-shadow: 0 10px 40px rgba(0, 0, 0, 0.04);
            --text-main: #1d1d1f;
            --text-muted: #86868b;
            --accent: #000000;
            --accent-light: #333333;
            --success: #34c759;
            --danger: #ff3b30;
            --dark-player: #000000;
            --sidebar-width: 280px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Cairo', sans-serif;
            -webkit-tap-highlight-color: transparent;
            will-change: transform, opacity;
        }

        body {
            background-color: #f5f5f7;
            color: var(--text-main);
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ø§Ù„Ù‡Ø§Ø¯Ø¦Ø© */
        .liquid-bg {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: -2;
            background: #ffffff;
            overflow: hidden;
        }

        .blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(90px);
            opacity: 0.5;
            animation: float 25s infinite alternate cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateZ(0); /* ÙØ±Ø¶ ØªØ³Ø±ÙŠØ¹ ÙƒØ§Ø±Øª Ø§Ù„Ø´Ø§Ø´Ø© */
        }

        .blob-1 { width: 50vw; height: 50vw; background: #e2e2e8; top: -10%; right: -10%; }
        .blob-2 { width: 60vw; height: 60vw; background: #f5f5f7; bottom: -20%; left: -10%; animation-delay: -5s; }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(30px) saturate(150%);
            -webkit-backdrop-filter: blur(30px) saturate(150%);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            box-shadow: var(--glass-shadow);
        }

        /* ==========================================================================
           2. Ø´Ø§Ø´Ø© Ø§Ù„Ù‚ÙÙ„ (Apple Login Style)
           ========================================================================== */
        #lock-screen {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(50px) saturate(200%);
            -webkit-backdrop-filter: blur(50px) saturate(200%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            /* Ø§Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ØªÙƒØ¨ÙŠØ± ÙˆØªÙ„Ø§Ø´ÙŠ Ù„ÙŠØ¯Ø®Ù„Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ */
            transition: transform 0.7s cubic-bezier(0.7, 0, 0.3, 1), opacity 0.6s ease;
            transform-origin: center center;
        }

        #lock-screen.unlocked {
            transform: scale(1.3);
            opacity: 0;
            pointer-events: none;
        }

        .user-avatar {
            width: 100px; height: 100px;
            border-radius: 50%;
            background: var(--text-main);
            display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem; color: white;
            margin-bottom: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .welcome-text {
            font-size: 1.8rem; font-weight: 800; margin-bottom: 2rem;
            letter-spacing: -0.5px;
        }

        .login-box {
            display: flex; flex-direction: column; gap: 1rem;
            width: 100%; max-width: 300px;
        }

        .apple-input {
            width: 100%; padding: 1rem 1.5rem;
            border-radius: 14px;
            border: 1px solid rgba(0,0,0,0.1);
            background: rgba(255,255,255,0.8);
            font-size: 1.1rem; text-align: center;
            outline: none; transition: all 0.3s;
        }
        
        .apple-input:focus { 
            border-color: var(--accent); 
            background: #fff; 
            box-shadow: 0 0 0 3px rgba(0,0,0,0.05);
        }

        .apple-btn {
            width: 100%; padding: 1rem; border-radius: 14px;
            background: var(--text-main); color: white;
            border: none; font-size: 1.1rem; font-weight: 800;
            cursor: pointer; transition: transform 0.2s;
        }
        .apple-btn:active { transform: scale(0.97); }

        #auth-error { 
            color: var(--danger); font-size: 0.95rem; font-weight: 800; 
            margin-top: 0.5rem; text-align: center; display: none; 
        }

        /* ==========================================================================
           3. Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Dashboard)
           ========================================================================== */
        #app-core {
            display: flex;
            width: 100%;
            min-height: 100vh;
            position: relative;
            z-index: 1; /* ÙŠÙ‚Ø¨Ø¹ ØªØ­Øª Ø´Ø§Ø´Ø© Ø§Ù„Ù‚ÙÙ„ */
        }

        .sidebar {
            width: var(--sidebar-width); height: 100vh;
            position: fixed; right: 0; top: 0;
            padding: 2rem 1.5rem; display: flex; flex-direction: column; gap: 1.5rem;
            z-index: 100; transition: transform 0.4s ease;
            border-radius: 0; border-left: 1px solid var(--glass-border); border-right: none;
        }

        .sidebar-brand {
            font-size: 2rem; font-weight: 900; color: var(--text-main);
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            letter-spacing: -1px;
            margin-bottom: 1rem;
        }

        .nav-menu { list-style: none; display: flex; flex-direction: column; gap: 0.5rem; }
        .nav-item {
            padding: 1rem 1.2rem; border-radius: 14px; cursor: pointer;
            font-weight: 800; display: flex; align-items: center; gap: 1rem;
            transition: all 0.2s ease; color: var(--text-muted);
        }
        .nav-item.active, .nav-item:hover {
            background: var(--text-main); color: white;
        }

        .main-content {
            margin-right: var(--sidebar-width); width: calc(100% - var(--sidebar-width));
            padding: 2.5rem; min-height: 100vh;
        }

        .top-nav { display: none; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .menu-btn { font-size: 1.5rem; background: none; border: none; cursor: pointer; color: var(--text-main); }

        /* Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø§Øª */
        .view-section { display: none; animation: fadeUp 0.4s ease forwards; }
        .view-section.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* ==========================================================================
           4. Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬
           ========================================================================== */
        .search-area { padding: 2rem; margin-bottom: 2rem; }
        .input-group { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
        .search-input {
            flex: 1; padding: 1.2rem 1.5rem; font-size: 1.1rem; font-weight: 600;
            border-radius: 14px; border: 1px solid var(--glass-border);
            background: rgba(255,255,255,0.7); color: var(--text-main); outline: none;
            transition: all 0.3s;
        }
        .search-input:focus { background: #fff; box-shadow: 0 0 0 3px rgba(0,0,0,0.05); border-color: var(--text-muted); }
        
        .btn-extract {
            background: var(--text-main); color: white; border: none; padding: 0 2.5rem;
            border-radius: 14px; font-size: 1.1rem; font-weight: 800; cursor: pointer;
            transition: all 0.2s; display: flex; align-items: center; gap: 0.8rem;
        }
        .btn-extract:hover { background: var(--accent-light); }
        .btn-extract:disabled { background: #d1d1d6; cursor: not-allowed; color: #86868b; }

        .options-row { display: flex; gap: 1.5rem; flex-wrap: wrap; }
        .toggle-switch { display: flex; align-items: center; gap: 0.5rem; font-weight: 800; cursor: pointer; user-select: none; }
        .toggle-switch input { width: 20px; height: 20px; accent-color: var(--text-main); cursor: pointer; }

        /* ==========================================================================
           5. Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø­ÙŠØ©
           ========================================================================== */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { padding: 1.8rem; text-align: center; }
        .stat-card i { font-size: 2rem; color: var(--text-main); margin-bottom: 1rem; }
        .stat-card h4 { font-size: 1rem; color: var(--text-muted); margin-bottom: 0.5rem; font-weight: 800;}
        .stat-card p { font-size: 2rem; font-weight: 900; font-family: 'Inter', sans-serif; color: var(--text-main); }

        /* ==========================================================================
           6. Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…ÙˆØ­Ø¯Ø©
           ========================================================================== */
        .table-wrap { overflow-x: auto; border-radius: 14px; border: 1px solid var(--glass-border); margin-top: 1rem; }
        table { width: 100%; border-collapse: collapse; background: rgba(255,255,255,0.6); text-align: right; }
        th, td { padding: 1.2rem; border-bottom: 1px solid rgba(0,0,0,0.05); font-size: 0.95rem; font-weight: 600; }
        th { background: rgba(255,255,255,0.8); color: var(--text-muted); font-weight: 800; }
        tr:hover td { background: #ffffff; }

        .badge-res { background: #f2f2f7; color: var(--text-main); padding: 4px 10px; border-radius: 6px; font-family: 'Inter'; font-size: 0.85rem; font-weight: 800; border: 1px solid #e5e5ea; }
        .btn-action { background: var(--text-main); color: white; padding: 8px 18px; border-radius: 8px; text-decoration: none; font-weight: 800; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 6px; transition: transform 0.2s; border:none; cursor:pointer;}
        .btn-action:active { transform: scale(0.95); }
        .btn-danger { background: var(--danger); color: white; }

        /* ==========================================================================
           7. Ø§Ù„Ù…Ø´ØºÙ„
           ========================================================================== */
        .player-container { background: var(--dark-player); border-radius: 20px; overflow: hidden; aspect-ratio: 16/9; width: 100%; margin-bottom: 1.5rem; }
        video, audio { width: 100%; height: 100%; outline: none; }

        /* Loader */
        .loader-ring { display: none; width: 35px; height: 35px; border: 4px solid rgba(0,0,0,0.1); border-top-color: var(--text-main); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 2rem auto; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(100%); }
            .sidebar.open { transform: translateX(0); box-shadow: -20px 0 40px rgba(0,0,0,0.1); }
            .main-content { margin-right: 0; width: 100%; padding: 1.5rem; }
            .top-nav { display: flex; }
            .input-group { flex-direction: column; }
            .btn-extract { padding: 1.2rem; justify-content: center; }
        }
    </style>
</head>
<body>

    <div class="liquid-bg">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
    </div>

    <div id="lock-screen">
        <div class="user-avatar"><i class="fa-solid fa-apple-whole"></i></div>
        <div class="welcome-text">Welcome Abdallah</div>
        <div class="login-box">
            <input type="text" id="auth-user" class="apple-input" placeholder="Username" autocomplete="off">
            <input type="password" id="auth-pass" class="apple-input" placeholder="Password">
            <button class="apple-btn" onclick="unlockSystem()">Login</button>
            <div id="auth-error">Incorrect Credentials</div>
        </div>
    </div>

    <div id="app-core">
        <aside class="sidebar glass-panel" id="sidebar">
            <div class="sidebar-brand">EG</div>
            <ul class="nav-menu">
                <li class="nav-item active" onclick="switchView('home', this)"><i class="fa-solid fa-bolt"></i> Ø§Ù„Ù…Ø­Ø±Ùƒ</li>
                <li class="nav-item" onclick="switchView('stats', this)"><i class="fa-solid fa-chart-simple"></i> Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©</li>
                <li class="nav-item" onclick="switchView('history', this)"><i class="fa-solid fa-clock-rotate-left"></i> Ø§Ù„Ø³Ø¬Ù„</li>
                <li class="nav-item" onclick="switchView('settings', this)"><i class="fa-solid fa-sliders"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</li>
                <li class="nav-item" style="color: var(--danger); margin-top: auto;" onclick="lockSystem()"><i class="fa-solid fa-lock"></i> Ù‚ÙÙ„</li>
            </ul>
        </aside>

        <main class="main-content">
            <nav class="top-nav">
                <h2 style="font-weight: 900;">EG</h2>
                <button class="menu-btn" onclick="document.getElementById('sidebar').classList.toggle('open')"><i class="fa-solid fa-bars"></i></button>
            </nav>

            <section id="view-home" class="view-section active">
                <div class="search-area glass-panel">
                    <h2 style="margin-bottom: 1.5rem; font-weight: 900;">EG Engine</h2>
                    <div class="input-group">
                        <input type="text" id="media-url" class="search-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ø¨Ø­Ø« Ù‡Ù†Ø§...">
                        <button id="btn-submit" class="btn-extract" onclick="requestExtraction()">Ø§Ø³ØªØ®Ø±Ø§Ø¬</button>
                    </div>
                    <div class="options-row">
                        <label class="toggle-switch"><input type="checkbox" id="opt-audio" checked> ÙˆØ¶Ø¹ Ø§Ù„ØµÙˆØª (Ø£Ø³Ø±Ø¹)</label>
                        <label class="toggle-switch"><input type="checkbox" id="opt-refresh"> ØªØ­Ø¯ÙŠØ« Ø¥Ø¬Ø¨Ø§Ø±ÙŠ (Ø¨Ø¯ÙˆÙ† ÙƒØ§Ø´)</label>
                    </div>
                    <div id="main-loader" class="loader-ring"></div>
                </div>

                <div id="result-display" style="display: none;">
                    <div class="player-container" id="player-box"></div>
                    
                    <div class="glass-panel" style="padding: 1.5rem; margin-bottom: 2rem;">
                        <h3 id="res-title" style="margin-bottom: 1rem; font-weight: 900;">...</h3>
                        <div style="display: flex; gap: 1rem; font-family: Inter; font-weight: 800; color: var(--text-muted); font-size: 0.9rem;">
                            <span id="res-time"></span> | <span id="res-method"></span> | <span id="res-live"></span>
                        </div>
                    </div>

                    <div class="glass-panel" style="padding: 1.5rem;">
                        <h3 style="font-weight: 900; margin-bottom: 1rem;">Ø§Ù„Ø¬ÙˆØ¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</h3>
                        <div class="table-wrap">
                            <table id="formats-table">
                                <thead><tr><th>Ø§Ù„ØµÙŠØºØ©</th><th>Ø§Ù„Ø¬ÙˆØ¯Ø©</th><th>ÙƒÙˆØ¯Ùƒ</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section id="view-stats" class="view-section">
                <h2 style="margin-bottom: 1.5rem; font-weight: 900;">Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
                <div class="stats-grid">
                    <div class="stat-card glass-panel">
                        <i class="fa-solid fa-network-wired"></i>
                        <h4>WebSockets</h4>
                        <p id="stat-ws">0</p>
                    </div>
                    <div class="stat-card glass-panel">
                        <i class="fa-solid fa-microchip"></i>
                        <h4>RAM Usage</h4>
                        <p id="stat-ram">-- MB</p>
                    </div>
                    <div class="stat-card glass-panel">
                        <i class="fa-solid fa-server"></i>
                        <h4>Total Requests</h4>
                        <p id="stat-reqs">0</p>
                    </div>
                    <div class="stat-card glass-panel">
                        <i class="fa-solid fa-database"></i>
                        <h4>Cache Items</h4>
                        <p id="stat-cache">0</p>
                    </div>
                </div>
                <button class="btn-action" onclick="fetchAdminStats()"><i class="fa-solid fa-rotate"></i> ØªØ­Ø¯ÙŠØ«</button>
            </section>

            <section id="view-history" class="view-section">
                <h2 style="margin-bottom: 1.5rem; font-weight: 900;">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h2>
                <div class="glass-panel" style="padding: 1.5rem;">
                    <div class="table-wrap">
                        <table id="history-table">
                            <thead><tr><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <button class="btn-action btn-danger" style="margin-top: 1.5rem;" onclick="clearHistory()"><i class="fa-solid fa-trash"></i> Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
                </div>
            </section>

            <section id="view-settings" class="view-section">
                <h2 style="margin-bottom: 1.5rem; font-weight: 900;">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª EG</h2>
                <div class="glass-panel" style="padding: 2rem; display: flex; flex-direction: column; gap: 2rem;">
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 1.5rem;">
                        <div>
                            <h3 style="font-weight: 800;">Ø§Ù„Ù…Ù†Ø¸Ù Ø§Ù„Ø°ÙƒÙŠ</h3>
                            <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 5px;">ÙŠÙØ­Øµ Ø§Ù„ÙƒØ§Ø´ ÙˆÙŠÙ…Ø³Ø­ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªØ§Ù„ÙØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</p>
                        </div>
                        <label class="toggle-switch"><input type="checkbox" id="cfg-validator" checked onchange="updateServerConfig()"></label>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 1.5rem;">
                        <div>
                            <h3 style="font-weight: 800;">Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ WebSockets</h3>
                            <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 5px;">Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ÙØªØ­ Ø§ØªØµØ§Ù„Ø§Øª Ø¯Ø§Ø¦Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©.</p>
                        </div>
                        <label class="toggle-switch"><input type="checkbox" id="cfg-ws" checked onchange="updateServerConfig()"></label>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="font-weight: 800;">Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©</h3>
                            <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 5px;">Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø±Ø§Ù… Ø§Ù„Ø³ÙŠØ±ÙØ±.</p>
                        </div>
                        <button class="btn-action btn-danger" onclick="clearServerCache()">ØªÙ†ÙÙŠØ°</button>
                    </div>

                </div>
            </section>

        </main>
    </div>

    <script>
        /* ==========================================================================
           Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ø£Ù…Ù†ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ (Ù…ÙØªØ§Ø­ Ø§Ù„Ù€ API Ø«Ø§Ø¨Øª ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯)
           ========================================================================== */
        const API_KEY = "Titan_2026_Ultra_Fast"; // Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù„Ø³ÙŠØ±ÙØ± Ù„Ø§ ØªÙ‚Ù… Ø¨ØªØºÙŠÙŠØ±Ù‡
        const BASE_URL = window.location.origin;
        let wsConnection = null;

        // ÙØ­Øµ Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³Ø¨Ù‚Ø©
        if (sessionStorage.getItem("eg_unlocked") === "true") {
            const lock = document.getElementById("lock-screen");
            lock.style.display = "none";
            initSystem();
        }

        function unlockSystem() {
            const u = document.getElementById("auth-user").value;
            const p = document.getElementById("auth-pass").value;
            const err = document.getElementById("auth-error");

            if (u === "admin" && p === "asdfghjkl05896") {
                err.style.display = "none";
                const lock = document.getElementById("lock-screen");
                
                // Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ø§Ø®ØªØ±Ø§Ù‚ Ø§Ù„Ù†Ø§Ø¹Ù…
                lock.classList.add("unlocked");
                
                setTimeout(() => {
                    lock.style.display = "none";
                    sessionStorage.setItem("eg_unlocked", "true");
                    initSystem();
                }, 700); // ÙŠØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ù…Ø¯Ø© Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ ÙÙŠ Ø§Ù„Ù€ CSS
            } else {
                err.style.display = "block";
            }
        }

        function lockSystem() {
            sessionStorage.removeItem("eg_unlocked");
            location.reload();
        }

        /* ==========================================================================
           Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª (SPA)
           ========================================================================== */
        function switchView(viewId, el) {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('view-' + viewId).classList.add('active');
            el.classList.add('active');
            if(window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('open');
            
            if(viewId === 'stats') fetchAdminStats();
            if(viewId === 'history') loadHistory();
        }

        /* ==========================================================================
           ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø§Ø³ÙˆØ±Ø© Ù„Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹ Ø§Ù„Ø¯Ø§Ø¦Ù…
           ========================================================================== */
        function initSystem() {
            connectWebSocket();
            fetchAdminStats();
            setInterval(fetchAdminStats, 15000); 
        }

        function connectWebSocket() {
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            wsConnection = new WebSocket(`${wsProtocol}//${location.host}/api/v1/ws/stream`);

            wsConnection.onopen = () => {
                console.log("EG Pipe Open");
                wsConnection.send(JSON.stringify({ auth: API_KEY }));
            };

            wsConnection.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleExtractionResult(data);
            };

            wsConnection.onclose = () => {
                setTimeout(connectWebSocket, 5000);
            };
        }

        /* ==========================================================================
           Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙˆØ§Ù„Ø¨Ø­Ø« ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
           ========================================================================== */
        async function requestExtraction() {
            const url = document.getElementById("media-url").value.trim();
            if (!url) return;

            document.getElementById("main-loader").style.display = "block";
            document.getElementById("result-display").style.display = "none";
            document.getElementById("btn-submit").disabled = true;

            const isAudio = document.getElementById("opt-audio").checked;
            const refresh = document.getElementById("opt-refresh").checked;

            if (wsConnection && wsConnection.readyState === WebSocket.OPEN && !refresh) {
                wsConnection.send(JSON.stringify({ url: url, audio_only: isAudio }));
            } else {
                try {
                    const res = await fetch(`${BASE_URL}/api/v1/extract?url=${encodeURIComponent(url)}&audio_only=${isAudio}&force_refresh=${refresh}`, {
                        headers: { 'X-Titan-Key': API_KEY, 'Accept': 'application/json' }
                    });
                    const data = await res.json();
                    handleExtractionResult(data);
                } catch (e) {
                    alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø³ÙŠØ±ÙØ± EG.");
                    resetExtractionUI();
                }
            }
        }

        document.getElementById('media-url').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') requestExtraction();
        });

        function handleExtractionResult(data) {
            resetExtractionUI();
            if (!data.success) {
                alert("ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬: " + data.message);
                return;
            }

            document.getElementById("result-display").style.display = "block";
            document.getElementById("res-title").innerText = data.title;
            document.getElementById("res-time").innerText = `${data.process_time_ms} ms`;
            document.getElementById("res-method").innerText = data.cached ? "âš¡ Ù…Ø³Ø­ÙˆØ¨ Ù…Ù† Ø§Ù„Ø±Ø§Ù…" : "ğŸŒ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø­ÙŠ";
            document.getElementById("res-live").innerText = data.is_live ? "Ø¨Ø« Ù…Ø¨Ø§Ø´Ø±" : "Ù…Ø³Ø¬Ù„";

            // Ø§Ù„Ù…Ø´ØºÙ„
            const pBox = document.getElementById("player-box");
            pBox.innerHTML = "";
            let mediaType = data.smart_formats && data.smart_formats.audio_only && data.smart_formats.audio_only.length > 0 ? "audio" : "video";
            if(data.is_live) mediaType = "video";
            
            const player = document.createElement(mediaType);
            player.controls = true;
            player.src = data.direct_stream_url;
            pBox.appendChild(player);

            // Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
            const tbody = document.querySelector("#formats-table tbody");
            tbody.innerHTML = "";
            
            let allFormats = [];
            if(data.smart_formats) {
                allFormats = [...data.smart_formats.best_muxed, ...data.smart_formats.audio_only, ...data.smart_formats.video_only];
            }

            allFormats.slice(0, 15).forEach(f => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td><span class="badge-res">${f.ext}</span></td>
                    <td dir="ltr" style="font-weight:800; color:var(--text-main);">${f.resolution}</td>
                    <td>${f.vcodec !== 'none' ? f.vcodec : f.acodec}</td>
                    <td>
                        <a href="${f.url}" target="_blank" class="btn-action"><i class="fa-solid fa-download"></i></a>
                        <a href="${f.url}" target="_blank" class="btn-action" style="background:#000;"><i class="fa-solid fa-play"></i></a>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            saveToHistory(data.title, mediaType, data.direct_stream_url);
        }

        function resetExtractionUI() {
            document.getElementById("main-loader").style.display = "none";
            document.getElementById("btn-submit").disabled = false;
        }

        /* ==========================================================================
           Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ù„ÙŠ (History)
           ========================================================================== */
        function saveToHistory(title, type, url) {
            let hist = JSON.parse(localStorage.getItem("eg_history") || "[]");
            hist.unshift({ title, type, url, time: new Date().toLocaleString('ar-EG') });
            if(hist.length > 50) hist.pop();
            localStorage.setItem("eg_history", JSON.stringify(hist));
        }

        function loadHistory() {
            let hist = JSON.parse(localStorage.getItem("eg_history") || "[]");
            const tbody = document.querySelector("#history-table tbody");
            tbody.innerHTML = "";
            hist.forEach(h => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td style="max-width:200px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${h.title}</td>
                    <td><span class="badge-res">${h.type}</span></td>
                    <td dir="ltr">${h.time}</td>
                    <td><a href="${h.url}" target="_blank" class="btn-action" style="padding:6px 12px;"><i class="fa-solid fa-play"></i></a></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function clearHistory() {
            localStorage.removeItem("eg_history");
            loadHistory();
        }

        /* ==========================================================================
           Ø§ØªØµØ§Ù„Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Admin API)
           ========================================================================== */
        async function fetchAdminStats() {
            try {
                const res = await fetch(`${BASE_URL}/api/v1/admin/stats`, { headers: { 'X-Titan-Key': API_KEY } });
                const stats = await res.json();
                document.getElementById("stat-ws").innerText = stats.active_ws_connections;
                document.getElementById("stat-ram").innerText = stats.memory_usage;
                document.getElementById("stat-reqs").innerText = stats.total_requests;
                document.getElementById("stat-cache").innerText = stats.cached_files_count;
            } catch (e) {
                console.error("Stats fetch failed");
            }
        }

        async function clearServerCache() {
            if(!confirm("Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø±Ø§Ù…ØŸ")) return;
            try {
                const res = await fetch(`${BASE_URL}/api/v1/admin/clear_cache`, { method: "POST", headers: { 'X-Titan-Key': API_KEY } });
                const data = await res.json();
                if(data.success) {
                    alert("ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ø§Ù….");
                    fetchAdminStats();
                }
            } catch(e) {}
        }

        async function updateServerConfig() {
            const validator = document.getElementById("cfg-validator").checked;
            const ws = document.getElementById("cfg-ws").checked;
            try {
                await fetch(`${BASE_URL}/api/v1/admin/config`, { 
                    method: "POST", 
                    headers: { 'X-Titan-Key': API_KEY, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ smart_validation_enabled: validator, allow_new_ws_connections: ws })
                });
            } catch(e) {}
        }
    </script>
</body>
</html>
